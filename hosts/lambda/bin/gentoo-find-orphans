#!/bin/sh
. $ENV_HOME/scripts/functions.sh

VERSION="0.2.0"
LOGTO="~/orphans.log"

echoc 31 "Orphaned file finder $VERSION... by hexec (alessandro.rosetti@gmail.com)"

if [ $UID -ne 0 ]; then
    echoc 31 "Please run as root."
    exit $?

    if [ -d $1 ]; then
        echoc 31 "Searching \"$1\"\n"
    else
        echoc 31 "Directory \"$1\" not found"
        exit 1
    fi
fi

c=0
n=0
FLIST=$(find $1 -type d -print)
NUM=$(echo $FLIST | tr -s ' ' '\n' | wc -l)

echoc 31 "$NUM files to be analyzed.\n"

rm -f $LOGTO &>/dev/null

for f in $FLIST; do
    ((c++))
    echoc 32 "[$c/$NUM] $f                                                     "
    qfile $f &>/dev/null # equery b $f &> /dev/null
    RES=$?
    echo -e "\E[2A"
    if [ $RES -ne 0 ]; then
        ((n++))
        echoc 31 "[$n/$NUM] $f                                                 "
        echo $f >>~/orphans.log
    fi
done
